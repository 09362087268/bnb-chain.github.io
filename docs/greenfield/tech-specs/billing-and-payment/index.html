<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.9">
<link rel="search" type="application/opensearchdescription+xml" title="BNB Chain Documentation" href="/opensearch.xml">
<!-- Google Tag Manager -->
    <script>!function(e,t,a,n,g){e[n]=e[n]||[],e[n].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var m=t.getElementsByTagName(a)[0],r=t.createElement(a);r.async=!0,r.src="https://www.googletagmanager.com/gtm.js?id=GTM-W9BVQXM",m.parentNode.insertBefore(r,m)}(window,document,"script","dataLayer")</script>
    <!-- End Google Tag Manager --><title data-react-helmet="true">Billing and Payment | BNB Chain Documentation</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://bnb-chain.github.io//docs/greenfield/tech-specs/billing-and-payment"><meta data-react-helmet="true" name="docsearch:language" content="en"><meta data-react-helmet="true" name="docsearch:version" content="current"><meta data-react-helmet="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Billing and Payment | BNB Chain Documentation"><meta data-react-helmet="true" name="description" content="Greenfield will charge the users in two parts. Firstly, every transaction will require gas fees to pay the Greenfield validator to write the metadata on-chain. Secondly, the SPs charge the users for their storage service. Such payment also happens on the Greenfield. This section is about the latter: how such off-chain service fees are billed and charged."><meta data-react-helmet="true" property="og:description" content="Greenfield will charge the users in two parts. Firstly, every transaction will require gas fees to pay the Greenfield validator to write the metadata on-chain. Secondly, the SPs charge the users for their storage service. Such payment also happens on the Greenfield. This section is about the latter: how such off-chain service fees are billed and charged."><link data-react-helmet="true" rel="shortcut icon" href="/img/icon/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://bnb-chain.github.io//docs/greenfield/tech-specs/billing-and-payment"><link data-react-helmet="true" rel="alternate" href="https://bnb-chain.github.io//docs/greenfield/tech-specs/billing-and-payment" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://bnb-chain.github.io//docs/greenfield/tech-specs/billing-and-payment" hreflang="x-default"><link data-react-helmet="true" rel="preconnect" href="https://3LF005YNGZ-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.b3df100c.css">
<link rel="preload" href="/assets/js/runtime~main.d72b32ee.js" as="script">
<link rel="preload" href="/assets/js/main.e0455e9d.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbar--primary"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/image.png" alt="BNB" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/image.png" alt="BNB" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">BNB Chain Documentation</b></a></div><div class="navbar__items navbar__items--right"><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">ðŸŒœ</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">ðŸŒž</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div><div class="searchBox_NKBi"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_lDyR"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_i9tI" type="button"></button><aside class="docSidebarContainer_0YBq"><div class="sidebar_a3j0"><nav class="menu thin-scrollbar menu_cyFh"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">BNB Chain</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/getting-started">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BNB Smart Chain</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BNB Beacon Chain</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">BNB Sidechain</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">BNB Greenfield</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Design of BNB Greenfield</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">Potential UseCases</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#" tabindex="0">Technical Specifications</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/ecosystem-players">Ecosystem Players</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/user-identifier">User Identifier</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/greenfield-blockchain">Greenfield Blockchain</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/storage-metadata-models">Storage MetaData Models</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/payload-storage-mngt">Payload Storage Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/data-availability-challenge">Data Availability Challenge</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/storage-transactions">Storage Transactions</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/greenfield/tech-specs/billing-and-payment">Billing and Payment</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/cross-chain-models">Cross-Chain Models</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/greenfield/tech-specs/sp-apis">SP APIs</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#" tabindex="0">zkBNB</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Future Developments</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">FAQs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/contribute">How to Contribute</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs/more-help">More Help</a></li></ul></nav></div></aside><main class="docMainContainer_r8cw"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_zHA2"><div class="docItemContainer_oiyr"><article><div class="tocCollapsible_aw-L theme-doc-toc-mobile tocMobile_Tx6Y"><button type="button" class="clean-btn tocCollapsibleButton_zr6a">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Billing and Payment</h1></header><p>Greenfield will charge the users in two parts. Firstly, every transaction will require gas fees to pay the Greenfield validator to write the metadata on-chain. Secondly, the SPs charge the users for their storage service. Such payment also happens on the Greenfield. This section is about the latter: how such off-chain service fees are billed and charged.</p><p>There are two kinds of fees for the off-chain service: object storage fee and read package fee:</p><p>  <strong>1.</strong> Every object stored on Greenfield is charged a fee based on its size, content type, and other parameters.</p><p>  <strong>2.</strong> There is a free quota for users&#x27; objects to be read based on their size, content types, and more. If exceeded, i.e. the object data has been downloaded too many times, SP will limit the bandwidth for more downloads. Users can raise their data package level to get more download quota. Every data package has a fixed price.</p><p>As described in the <a href="/docs/greenfield/design/design-principles">Design Section</a>, the fees are paid on Greenfield in the style of &quot;Stream&quot; from users to the SPs at a constant rate. The fees are charged every second as they are used.</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="concepts-and-formulas">Concepts and Formulas<a aria-hidden="true" class="hash-link" href="#concepts-and-formulas" title="Direct link to heading">â€‹</a></h2><p>Streaming is a constant by-the-second movement of funds from a sending account to a receiving account. Instead of sending payment transactions now and then, Greenfield records the static balance, the latest update
timestamp, and flow rate in its payment module, and calculates the dynamic balance with a formula using this data in the records. If the net flow rate is not zero, the dynamic balance will change as time elapses.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="terminology">Terminology<a aria-hidden="true" class="hash-link" href="#terminology" title="Direct link to heading">â€‹</a></h3><ul><li><p><strong>Payment Module:</strong> This is a special module and ledger system managing the billing and payment on the Greenfield blockchain. Funds will be deposited or charged into it from users&#x27; balance or payment accounts in this Payment Module.</p></li><li><p><strong>Stream Account:</strong> The Payment Module has its own ledger for billing management. Users can deposit and withdraw funds into their corresponding &quot;<strong>accounts</strong>&quot; on the payment module ledger. These accounts are called &quot;<strong>Stream Account</strong>&quot;, which will directly interact with the stream payment functions and bill the users for the storage and data service.</p></li><li><p><strong>Payment Account:</strong> Payment account has been discussed in other sections of <a href="/docs/greenfield/design/design-principles">Design</a> and <a href="/docs/greenfield/tech-specs/ecosystem-players">Technical Specifications</a> already. It is actually a type of Stream Account. Users can create different payment accounts and associate it with different buckets for different purposes.</p></li><li><p><strong>Payment Stream:</strong> Whenever the users add/delete/change a storage object or download a data package, they add or change one or more &quot;payment streams&quot; for that service provided by SPs. </p></li><li><p><strong>Flow Rate:</strong> The per-second rate at which a sender decreases its net outflow stream and increases a receiver&#x27;s net inflow stream when creating or updating a payment stream.</p></li><li><p><strong>Netflow Rate:</strong> The per-second rate that an account&#x27;s balance is changing. It is the sum of the account&#x27;s inbound and outbound flow rates.</p></li><li><p><strong>Sender:</strong> The stream account that starts the payment stream by specifying a receiver and a flow rate at which its net flow decreases.</p></li></ul><ul><li><strong>Receiver</strong>: The stream account on the receiving end of one or more payment streams. </li></ul><ul><li><p><strong>CRUD Timestamp:</strong> The timestamp of when the user creates, updates, or deletes a payment stream.</p></li><li><p><strong>Delta Balance:</strong> The amount of the stream account&#x27;s balance has changed since the latest CRUD timestamp due to the flow. It can be positive or negative.</p></li><li><p><strong>Static Balance:</strong> The balance of the stream account at the latest CRUD timestamp.</p></li><li><p><strong>Dynamic Balance:</strong> The actual balance of a stream account. It is the sum of the Static Balance and the Delta Balance.</p></li></ul><p>When a user&#x27;s stream account is initiated in the payment module by deposit, several fields will be recorded for this stream account:</p><ul><li>CRUD Timestamp - will be the timestamp at the time.</li><li>Static Balance - will be the deposit amount.</li><li>Netflow Rate - will be 0.</li><li>Buffer Balance - will be 0.</li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="formula">Formula<a aria-hidden="true" class="hash-link" href="#formula" title="Direct link to heading">â€‹</a></h3><p>  <code>Static Balance = Initial Balance at latest CRUD timestamp</code></p><p>  <code>Delta Balance = Netflow Rate \* Seconds elapsed since latest CRUD timestamp</code></p><p>  <code>Current Balance = Static Balance + Delta Balance</code></p><p>  <code>Buffer Balance = - Netflow Rate \* pre-configed ReserveTime if Netflow Rate is negative</code></p><p><img alt="inflow-and-outflow-of-funds" src="/assets/images/21.1-How-a-User-Receives-Inflow-and-Outflow-of-Funds-6427f84b2e439b031ad3515245bb7329.jpg"></p><div align="center"><i>How a User Receives Inflow and Outflow of Funds</i></div><p>Every time a user creates, updates, or deletes a payment stream, many variables in the above formulas will be updated and the users&#x27; stream accounts in the payment module will be settled.</p><ul><li><p>The net flow for the user&#x27;s stream account in the payment module will be re-calculated to net all of its inbound and outbound flow rates by adding/removing the new payment stream against the current NetFlow Rate. E.g. when a user creates a new object whose price is \$0.4/month, its NetFlow Rate will add -\$0.4/month.</p></li><li><p>If the NetFlow rate is negative, the associated amount of BNB will be reserved in a buffer balance. It is used to avoid the dynamic balance becoming negative. When the dynamic balance becomes under the threshold, the account will be forced settled.</p></li><li><p>CRUD Timestamp will become the current timestamp.</p></li><li><p>Static Balance will be re-calculated. The previous dynamic balance will be settled. The new static Balance will be the Current Balance plus the change of the Buffer Balance.</p></li></ul><h4 class="anchor anchorWithStickyNavbar_y2LR" id="types-and-interfaces">Types and Interfaces<a aria-hidden="true" class="hash-link" href="#types-and-interfaces" title="Direct link to heading">â€‹</a></h4><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PaymentConfig </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Time duration which the buffer balance need to be reserved for NetOutFlow e.g. 6 month</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ReserveTime      </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Time duration threshold of forced settlement.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// If dynamic balance is less than NetOutFlowRate * forcedSettleTime, the account can be forced settled.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ForcedSettleTime </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> StreamPayment </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CRUDTimestamp </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    NetflowRate   </span><span class="token builtin">int64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    StaticBalance </span><span class="token builtin">uint64</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    BufferBalance </span><span class="token builtin">uint64</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// reserved balance for a period, e.g. 1 day</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PaymentKeeperI </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetStorePrice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">replicaNum</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> size </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">GetReadPackagePrice</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">packageType ReadPackageType</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">UpdatePaymentFlow</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rate </span><span class="token builtin">int64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">LiquidateAccount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="key-workflow">Key Workflow<a aria-hidden="true" class="hash-link" href="#key-workflow" title="Direct link to heading">â€‹</a></h2><h3 class="anchor anchorWithStickyNavbar_y2LR" id="deposit-and-withdrawal">Deposit and Withdrawal<a aria-hidden="true" class="hash-link" href="#deposit-and-withdrawal" title="Direct link to heading">â€‹</a></h3><p>All users(including SPs) can deposit and withdraw BNB in the payment
module. The <code>StaticBalance</code> in the <code>StreamPayment</code> data struct will be
&quot;<strong>settled</strong>&quot; first: the <code>CRUDTimeStamp</code> will be updated and <code>StaticBalance</code> will be netted with DeltaBalance. Then the deposit and withdrawal number will try to add/reduce the <code>StaticBalance</code> in the record. If the static balance is less than the withdrawal amount, the withdrawal will fail.</p><p>Deposit/withdrawal via cross-chain will also be supported to enable
users to deposit/withdraw from BSC directly.</p><p>Specifically, the payment deposit can be triggered automatically during
the creation of objects or the addition of data packages. As long as
users have assets in their address accounts and payment accounts, the
payment module may directly charge the users by moving the funds from
address accounts.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="payment-stream">Payment Stream<a aria-hidden="true" class="hash-link" href="#payment-stream" title="Direct link to heading">â€‹</a></h3><p>Payment streams are flowing in one direction. Whenever the users deposit
from their address accounts into the stream accounts (including users&#x27;
default payment account and other payment accounts), the funds first go
from the users&#x27; address accounts to a system account maintained by the
Payment Module, although the fund size and other payment parameters will
be recorded on the users&#x27; stream account, i.e. the StreamPayment record,
in the Payment Module ledger. When the payment is settled, the funds
will go from the system account to SPs&#x27; address accounts according to
their in-flow calculation.</p><p>Every time users do the actions below, their StreamPayment record will
be updated:</p><ul><li>Creating an object will create a new stream to the system account</li><li>Deleting an object will delete a stream to the system account</li><li>Adjusting the data packages for read/download will create/delete/update the associated streams</li></ul><p>The stream from the system account to storage providers will be updated
together when the users do the above actions. The in-flow flow rate of
SP will be recorded accurately in the payment module as well, such as
the total size stored(as primary or secondary SP), etc. The total
inbound flow will be split among the SPs according to the records.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="forced-settlement">Forced Settlement<a aria-hidden="true" class="hash-link" href="#forced-settlement" title="Direct link to heading">â€‹</a></h3><p>If a user doesn&#x27;t deposit for a long time, his previous deposit may be
all used up for the stored objects. Greenfield has a forced settlement
mechanism to ensure enough funds are secured for further service fees.</p><p>There are two configurations, <code>ReserveTime</code> and <code>ForcedSettleTime</code>. Let&#x27;s say 7 days and 1 day. If a user wants to store an object at the price of approximately $0.1 per month($0.00000004/second), he must reserve fees for 7 days in buffer balance, which is <code>$0.00000004 * 7 * 86400 = $0.024192</code>. If the user deposits $1 initially, the stream payment record will be as below.</p><ul><li>CRUD Timestamp: 100</li><li>Static Balance: $0.975808</li><li>Netflow Rate: -$0.00000004/sec</li><li>Buffer Balance: $0.024192</li></ul><p>After 10000 seconds, the dynamic balance of the user is <code>0.975808 - 10000 * 0.00000004 = 0.975408</code>.</p><p>After 24395200 seconds(approximately 282 days), the dynamic balance of
the user will become negative. Users should have some alarms for such
events that remind them to supply more funds in time.</p><p>If no more funds are supplied and the dynamic balance plus buffer
balance is under the forced settlement threshold, the account will be
forcibly settled. All payment streams of the account will be closed and
the account will be marked as out of balance. The download speed for all
objects associated with the account or payment account will be
downgraded. The objects will be deleted by the SPs if no fund is
provided within the predefined threshold.</p><p>The forced settlement will also charge some fees which is another
incentive for users to replenish funds proactively.</p><p>Let&#x27;s say the ForceSettlementTime is 1 day. After 24913601
seconds(approximately 288 days), the dynamic balance becomes <code>0.975808 -
24913601 *0.00000004 = -0.02073604</code>, plus the buffer balance is
$0.00345596. The forced settlement threshold is <code>86400* 0.00000004 =
0.003456</code>. The forced settlement will be triggered, and the record of the user will become as below:</p><ul><li>CRUD Timestamp: 24913701</li><li>Static Balance: \$0</li><li>Netflow Rate: \$0/sec</li><li>Buffer Balance: \$0</li></ul><p>The validators will get the remaining $0.00345596 as a reward. The
account will be marked as &quot;insufficient&quot; and his objects get downgraded
by SPs.</p><p>Every time a stream record is updated, Greenfield calculates the time
when the account will be out of balance. So Greenfield can keep an
on-chain list to trace the timestamps for the potential forced
settlement. The list will be checked by the end of every block
processing. When the block time passes the forced settlement timestamp,
the settlement of the associated stream accounts will be triggered
automatically.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="payment-account">Payment Account<a aria-hidden="true" class="hash-link" href="#payment-account" title="Direct link to heading">â€‹</a></h3><p>Payment account is a special &quot;<strong>Stream Account</strong>&quot; type in the Payment
Module. Users can create multiple payment accounts and have the
permission to link buckets to different payment accounts to pay for
storage and data package.</p><p>The relevant data structures and interface are as the following:</p><div class="codeBlockContainer_J+bg"><div class="codeBlockContent_csEI go"><pre tabindex="0" class="prism-code language-go codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// PaymentAccountNum mapping</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// key: PaymentAccountNumPrefix | Address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// value: uint64  // counter</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// use cases:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - record the number of payment accounts of a user</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - derive new payment account address from user address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// - PaymentAccountAddress = Hash(OwnerAddress | current_num), increased by 1 when create a new payment account</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// key: PaymentAccountPrefix | Address</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PaymentAccount </span><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Owner        Address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Withdrawable </span><span class="token builtin">bool</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> PaymentKeeperI </span><span class="token keyword" style="color:#00009f">interface</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Deposit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">Withdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">from</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> to Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> amount </span><span class="token builtin">uint64</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">CreatePaymentAccount</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">addr Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">paymentAccountAddr Address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> err </span><span class="token builtin">error</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">ForbidWithdraw</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> paymentAccount Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetBucketStorePayer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucket BucketID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payer Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">SetBucketReadDataPayer</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucket BucketID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sender</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> payer Address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token builtin">error</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>The payment accounts have the below traits:</p><ul><li><p>Every user can create multiple payment accounts. The payment accounts created by the user are recorded with a map on the BNB Greenfield blockchain.</p></li><li><p>The address format of the payment account is the same as normal accounts. It&#x27;s derived by the hash of the user address and payment account index. The payment account only exists in the storage payment module. Users can deposit into, withdraw from and query the balance of payment accounts in the payment module, which means payment accounts cannot be used for transfer or staking.</p></li><li><p>Users can only associate their buckets with their payment accounts to pay for storage and bandwidth. Users cannot associate their own buckets with others&#x27; payment accounts, and users cannot associate others&#x27; buckets with their own payment accounts.</p></li><li><p>The owner of a payment account is the user who creates it. The owner can set it non-refundable. It&#x27;s a one-way setting and can not be revoked. Thus users can set some objects as &quot;public goods&quot; which can receive donations for storage and bandwidth while preserving the ownership.</p></li></ul><h3 class="anchor anchorWithStickyNavbar_y2LR" id="account-freeze-and-resume">Account Freeze and Resume<a aria-hidden="true" class="hash-link" href="#account-freeze-and-resume" title="Direct link to heading">â€‹</a></h3><p>If a payment account is out of balance, it will be settled and set a
flag as out of balance.</p><p>The NetflowRate will be set to 0, while the current settings of the
stream pay will be backed up in another data structure. The download
speed for all objects under this account will be downgraded.</p><p>If someone deposits into a frozen account and the static balance is
enough for reserved fees, the account will be resumed automatically. The
stream pay will be recovered from the backup.</p><p>During the OutOfBalance period, no objects can be associated with this
payment account again, which results in no object can be created under
the bucket associated with the account.</p><p>If the associated object is deleted, the backup stream pay settings will
be changed accordingly to ensure it reflects the latest once the account
is resumed.</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="storage-fee-price-and-adjustment">Storage Fee Price and Adjustment<a aria-hidden="true" class="hash-link" href="#storage-fee-price-and-adjustment" title="Direct link to heading">â€‹</a></h3><p>The object storage fee is calculated with a function of object metadata
and time. The unit of the price will be US dollars. The payment actually
charged on Greenfield is BNB, and the price of BNB will be submitted by
the oracle.</p><p>For example, if the price is 0.03 USD / GB / month, the current BNB
price on-chain is 258 USD, 70% of the storage fee will be received by
the primary SP, and the rest are split by secondary SPs.</p><p>When an object of 123, 456, 789 bytes(approximately 123 MB) is sealed,
there will be 7 payment streams updated. The fee rate is <code>0.03 / 258 *
123456789 / (1024*1024*1024) / (30*24*60*60) = 5.158003812501789e-12</code>
BNB/second.</p><p>Let&#x27;s set the rate as R.</p><ul><li>User -<!-- -->&gt;<!-- --> Primary SP flow rate: 0.7 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 1 flow rate: 0.05 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 2 flow rate: 0.05 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 3 flow rate: 0.05 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 4 flow rate: 0.05 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 5 flow rate: 0.05 <!-- -->*<!-- --> R</li><li>User -<!-- -->&gt;<!-- --> Secondary SP 6 flow rate: 0.05 <!-- -->*<!-- --> R</li></ul><p>The stream records of the payment accounts will be adjusted. If the
reserved time is 6 months, the user has to reserve <code>(R * 6 * 30 * 24 * 60 * 60) = 8.021727529202782e-05</code> BNB in
the Buffer Balance. If the balance of the payment account is not enough, either the trigger
transaction will fail or the account will be marked as &quot;insufficient&quot;.</p><p>The BNB price will be submitted by an oracle from the Greenfield
validator relayers periodically. When the price updates, all payment
prices will be calculated with the latest price. But all the flow rates
of existing payments will remain unchanged until the next settlement,
triggered by either the user&#x27;s new actions like putting a new object or
the auto-settlement.</p><p>The object storage fee price formula is expected to be steady since the
price unit is USD and the cost of storage changes slowly over time. The
formula might be flexible enough so it can be hard-coded on-chain.</p><p>There may be a chance the SPs want to change the formula(e.g. for
business model update). That will be achieved by SPs and validators&#x27;
coordinated governance.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/bnb-chain/bnb-chain.github.io/blob/master/docs/greenfield/tech-specs/billing-and-payment.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_mt2f"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/greenfield/tech-specs/storage-transactions"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Storage Transactions</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/docs/greenfield/tech-specs/cross-chain-models"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cross-Chain Models<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_vrFS thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#concepts-and-formulas" class="table-of-contents__link toc-highlight">Concepts and Formulas</a><ul><li><a href="#terminology" class="table-of-contents__link toc-highlight">Terminology</a></li><li><a href="#formula" class="table-of-contents__link toc-highlight">Formula</a></li></ul></li><li><a href="#key-workflow" class="table-of-contents__link toc-highlight">Key Workflow</a><ul><li><a href="#deposit-and-withdrawal" class="table-of-contents__link toc-highlight">Deposit and Withdrawal</a></li><li><a href="#payment-stream" class="table-of-contents__link toc-highlight">Payment Stream</a></li><li><a href="#forced-settlement" class="table-of-contents__link toc-highlight">Forced Settlement</a></li><li><a href="#payment-account" class="table-of-contents__link toc-highlight">Payment Account</a></li><li><a href="#account-freeze-and-resume" class="table-of-contents__link toc-highlight">Account Freeze and Resume</a></li><li><a href="#storage-fee-price-and-adjustment" class="table-of-contents__link toc-highlight">Storage Fee Price and Adjustment</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/getting-started">Getting Started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://forum.bnbchain.org/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>BNB Chain Forum<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://www.bnbchain.org/en/blog/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://github.com/bnb-chain" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.com/invite/bnbchain" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://twitter.com/BNBCHAIN" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="http://t.me/bnbchain" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Telegram<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2023 Build N Build.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.d72b32ee.js"></script>
<script src="/assets/js/main.e0455e9d.js"></script>
<!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-W9BVQXM" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) --></body>
</html>